/**
 * @file Exploit_Off_by_one_Error.py
 * @brief Script di verifica per CWE-787 Off-by-one Error
 * Target: build/CWE-787 Off-by-one Error
 *
 * NOTA: Questo exploit è dimostrativo. Poiché la vuln non prende input,
 * usiamo questo script per compilare ed eseguire con Valgrind se disponibile
 * o verificare l'output se possibile.
 */
import subprocess
import os

def check_vuln():
    exe = "../build/CWE-787 Off-by-one Error"
    src = "../vulnerabili/CWE-787 Off-by-one Error.c"
    
    print(f"[*] Compilazione di {src}...")
    # Compiliamo senza stack protector per facilitare l'evidenza del problema
    compile_cmd = f"gcc -fno-stack-protector -o '{exe}' '{src}'"
    os.system(compile_cmd)
    
    print(f"[*] Esecuzione del target {exe}...")
    try:
        # Eseguiamo semplicemente il binario. 
        # Un off-by-one di 1 byte sullo stack potrbbe non causare crash immediato senza canary,
        # ma corrompe l'ultimo byte del frame pointer salvato (su archit. 32/64 bit classiche).
        result = subprocess.run([exe], capture_output=True, text=True, timeout=2)
        print(f"Output Standard: {result.stdout}")
        
        if result.returncode != 0:
            print(f"[+] CRASH RILEVATO! Return code: {result.returncode}")
            print(f"Error Output: {result.stderr}")
        else:
            print("[-] Nessun crash visibile (comune per Off-by-one piccoli senza strumenti di analisi).")
            print("    Consiglio: Esegui con Valgrind per confermare:")
            print(f"    valgrind {exe}")

    except Exception as e:
        print(f"Errore esecuzione: {e}")

if __name__ == "__main__":
    check_vuln()
