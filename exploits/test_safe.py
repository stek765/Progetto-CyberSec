import subprocess
import os
import time

def compile_safe():
    print("[*] Compiling safe binaries...")
    # Assumes we are in 'exploits' dir
    compile_cmd = [
        "gcc -no-pie -fno-stack-protector -z execstack -o ../build/safe1 ../non_vulnerabili/safe1.c",
        "gcc -no-pie -fno-stack-protector -z execstack -o ../build/safe2 ../non_vulnerabili/safe2.c",
        "gcc -no-pie -fno-stack-protector -z execstack -o ../build/safe3 ../non_vulnerabili/safe3.c",
        "gcc -no-pie -fno-stack-protector -z execstack -o ../build/safe4 ../non_vulnerabili/safe4.c",
        "gcc -no-pie -fno-stack-protector -z execstack -o ../build/safe5 ../non_vulnerabili/safe5.c"
    ]
    
    for cmd in compile_cmd:
        try:
            subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT)
            print(f"   [+] Compiled {cmd.split()[-1]}")
        except subprocess.CalledProcessError as e:
            print(f"   [-] Failed to compile: {e.output.decode()}")
            return False
    return True

def run_test():
    print("\n[*] Running attacks against patched binaries...")
    for i in range(1, 6):
        target = f"../build/safe{i}"
        script = f"exploit_vuln{i}.py"
        
        print(f"\n[?] Testing {script} against {target}...")
        
        try:
            # Run the exploit script targetting the safe binary
            # We set a timeout because if it spawns a shell (unlikely) or hangs, we want to kill it
            # But since interactive only runs on success, correct termination should be fast
            result = subprocess.run(
                ["python3", script, target], 
                capture_output=True, 
                text=True, 
                timeout=5
            )
            
            output = result.stdout + result.stderr
            
            if "Spawning shell" in output:
                print(f"   [!] FAILURE: Exploit SUCCEEDED against safe binary {i}!")
                print("   Output snippet:", output[:200])
            else:
                print(f"   [+] SUCCESS: Exploit failed (as expected).")
                # print("   Debug output:", output[:100].replace('\n', ' '))
                
        except subprocess.TimeoutExpired:
             # Timeout means it might be stuck, likely didn't spawn shell cleanly or just waiting for input that never comes
             print(f"   [+] SUCCESS: Exploit timed out (did not pop shell).")
        except Exception as e:
            print(f"   [!] Error running test: {e}")

if __name__ == "__main__":
    if compile_safe():
        run_test()
