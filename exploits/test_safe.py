import subprocess
import os
import time

def compile_safe():
    print("[*] Compiling safe binaries...")
    # List of (source_file, output_binary)
    targets = [
        ("CWE-787 Array OOB Write - Patched.c", "CWE-787 Array OOB Write - Patched"),
        ("CWE-120 Memcpy Overflow - Patched.c", "CWE-120 Memcpy Overflow - Patched"),
        ("CWE-121 Read Buffer Overflow - Patched.c", "CWE-121 Read Buffer Overflow - Patched"),
        ("CWE-122 Heap Overflow - Patched.c", "CWE-122 Heap Overflow - Patched"),
        ("CWE-787 Heap OOB Write - Patched.c", "CWE-787 Heap OOB Write - Patched")
    ]
    
    for src, bin_name in targets:
        # Assuming we are in 'exploits' dir, source in '../non_vulnerabili'
        cmd = f'gcc -no-pie -fno-stack-protector -z execstack -o "../build/{bin_name}" "../non_vulnerabili/{src}"'
        try:
            subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT)
            print(f"   [+] Compiled {bin_name}")
        except subprocess.CalledProcessError as e:
            print(f"   [-] Failed to compile {bin_name}: {e.output.decode()}")
            return False
    return True

def run_test():
    print("\n[*] Running attacks against patched binaries...")
    
    test_cases = [
        ("CWE-787 Array OOB Write - Patched", "CWE-787 Array OOB Write Stack Exploit.py"),
        ("CWE-120 Memcpy Overflow - Patched", "CWE-120 Memcpy Overflow Stack Exploit.py"),
        ("CWE-121 Read Buffer Overflow - Patched", "CWE-121 Read Buffer Overflow Stack Exploit.py"),
        ("CWE-122 Heap Overflow - Patched", "CWE-122 Heap Overflow Function Pointer Exploit.py"),
        ("CWE-787 Heap OOB Write - Patched", "CWE-787 Heap OOB Write Logic Bypass Exploit.py")
    ]

    for target_bin, script in test_cases:
        target_path = f"../build/{target_bin}"
        print(f"\n[?] Testing {script} against {target_bin}...")
        
        try:
            result = subprocess.run(
                ["python3", script, target_path], 
                capture_output=True, 
                text=True, 
                timeout=5
            )
            
            output = result.stdout + result.stderr
            
            if "Spawning shell" in output:
                print(f"   [!] FAILURE: Exploit SUCCEEDED against safe binary {target_bin}!")
                print("   Output snippet:", output[:200])
            else:
                print(f"   [+] SUCCESS: Exploit failed (as expected).")
                
                
        except subprocess.TimeoutExpired:
             print(f"   [+] SUCCESS: Exploit timed out (did not pop shell).")
        except Exception as e:
            print(f"   [!] Error running test: {e}")

if __name__ == "__main__":
    if compile_safe():
        run_test()
